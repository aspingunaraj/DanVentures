<!-- templates/index.html -->
{% extends "base.html" %}
{% block title %}Dashboard • Algo Bot{% endblock %}
{% block content %}

<div class="page-header mb-3">
  <h4 class="mb-0">Dashboard</h4>
  <span class="badge bg-info">live</span>
</div>

<div class="card shadow-soft mb-4">
  <div class="card-body">
    <div class="d-flex flex-wrap gap-2 mb-3">
      {% if not connected %}
        <a class="btn btn-primary" href="{{ url_for('connect') }}">Connect Zerodha</a>
      {% else %}
        {% if not feed_running %}
          <form class="d-inline" method="post" action="{{ url_for('feed_start') }}">
            <button class="btn btn-success" type="submit">Start Feed</button>
          </form>
        {% else %}
          <form class="d-inline" method="post" action="{{ url_for('feed_stop') }}">
            <button class="btn btn-outline-danger" type="submit">Stop Feed</button>
          </form>
        {% endif %}
        <form class="d-inline" method="post" action="{{ url_for('disconnect') }}">
          <button class="btn btn-outline-secondary" type="submit">Disconnect</button>
        </form>
      {% endif %}
    </div>

    <h5 class="card-title">Latest Prices</h5>
    <table class="table table-sm align-middle" id="ticks-table">
      <thead>
        <tr><th>Symbol</th><th class="text-end">Last Price</th><th class="text-end">Time (IST)</th></tr>
      </thead>
      <tbody>
        {% for s in symbols %}
          <tr>
            <td>{{ s }}</td>
            <td class="text-end">{{ last.get(s, '-') }}</td>
            <td class="text-end">—</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="text-muted small">Auto-refreshing every 2 seconds.</div>
  </div>
</div>

<div class="w-100"></div>
<div class="alert alert-warning d-flex align-items-center py-2 px-3 mt-2" role="alert" style="max-width:100%;">
  <div class="me-2 fw-semibold">Access Token:</div>
  <code id="fullTok" class="text-break" style="user-select:all;">
    {{ access_token or "(no token)" }}
  </code>
  <button id="copyTokBtn" class="btn btn-sm btn-outline-dark ms-3">Copy</button>
</div>


{% endblock %}

{% block scripts %}
<script>
async function refreshPrices() {
  try {
    const res = await fetch("{{ url_for('feed_status') }}");
    const data = await res.json();
    const tbody = document.querySelector("#ticks-table tbody");
    const rows = [];
    const last = data.last || {};
    const last_ts = data.last_ts || {};
    const symbols = Object.keys(last).sort();
    for (const s of symbols) {
      rows.push(`
        <tr>
          <td>${s}</td>
          <td class="text-end">${last[s]}</td>
          <td class="text-end">${toIST(last_ts[s] || "")}</td>
        </tr>`);
    }
    if (rows.length) tbody.innerHTML = rows.join("");
  } catch (e) {}
}
setInterval(refreshPrices, 2000);
</script>

<script>
document.getElementById("copyTokBtn")?.addEventListener("click", async () => {
  const el = document.getElementById("fullTok");
  const tok = el?.innerText?.trim();
  if (!tok || tok === "(no token)") return;
  try {
    await navigator.clipboard.writeText(tok);
    // quick visual feedback
    const old = event.target.textContent;
    event.target.textContent = "Copied!";
    setTimeout(()=> event.target.textContent = old, 1200);
  } catch (e) {}
});
</script>

{% endblock %}
